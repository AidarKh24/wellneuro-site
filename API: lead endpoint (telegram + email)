import { NextResponse } from "next/server";
import { Resend } from "resend";

export const runtime = "nodejs";

type LeadPayload = {
  name: string;
  contact: string;
  city: string;
  format: string;
  background: string;
  message?: string;
  source?: string;
};

function isValid(payload: any): payload is LeadPayload {
  if (!payload) return false;
  const req = ["name", "contact", "city", "format", "background"];
  return req.every((k) => typeof payload[k] === "string" && payload[k].trim().length > 0);
}

function escapeTelegram(text: string) {
  // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –≤ HTML —Ä–µ–∂–∏–º–µ
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

async function sendToTelegram(text: string) {
  const token = process.env.TELEGRAM_BOT_TOKEN;
  const chatId = process.env.TELEGRAM_CHAT_ID;

  if (!token || !chatId) {
    return { ok: false, reason: "TELEGRAM env not set" };
  }

  const url = `https://api.telegram.org/bot${token}/sendMessage`;
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      chat_id: chatId,
      text,
      parse_mode: "HTML",
      disable_web_page_preview: true,
    }),
  });

  if (!res.ok) {
    const err = await res.text().catch(() => "");
    return { ok: false, reason: `Telegram HTTP ${res.status}: ${err}` };
  }

  return { ok: true };
}

async function sendToEmail(subject: string, html: string, text: string) {
  const apiKey = process.env.RESEND_API_KEY;
  const toEmail = process.env.LEAD_TO_EMAIL;
  const fromEmail = process.env.LEAD_FROM_EMAIL; // –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–∑—Ä–µ—à—ë–Ω –≤ Resend

  if (!apiKey || !toEmail || !fromEmail) {
    return { ok: false, reason: "EMAIL env not set" };
  }

  const resend = new Resend(apiKey);

  try {
    const result = await resend.emails.send({
      from: fromEmail,
      to: toEmail,
      subject,
      html,
      text,
    });

    if ((result as any)?.error) {
      return { ok: false, reason: (result as any).error?.message || "Resend error" };
    }
    return { ok: true };
  } catch (e: any) {
    return { ok: false, reason: e?.message || "Resend exception" };
  }
}

export async function POST(req: Request) {
  try {
    const body = await req.json();

    if (!isValid(body)) {
      return NextResponse.json({ ok: false, error: "Invalid payload" }, { status: 400 });
    }

    const lead: LeadPayload = {
      name: body.name.trim(),
      contact: body.contact.trim(),
      city: body.city.trim(),
      format: body.format.trim(),
      background: body.background.trim(),
      message: (body.message || "").toString().trim(),
      source: (body.source || "wellneuro.ru (landing)").toString().trim(),
    };

    const ts = new Date().toISOString();

    const telegramText =
      "<b>–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ ‚Äî –í–µ–ª–Ω–µ–π—Ä–æ</b>\n" +
      `‚è± <b>–í—Ä–µ–º—è</b>: ${escapeTelegram(ts)}\n` +
      `üë§ <b>–ò–º—è</b>: ${escapeTelegram(lead.name)}\n` +
      `üìç <b>–ì–æ—Ä–æ–¥</b>: ${escapeTelegram(lead.city)}\n` +
      `üß© <b>–§–æ—Ä–º–∞—Ç</b>: ${escapeTelegram(lead.format)}\n` +
      `üßë‚Äçüíº <b>–ö—Ç–æ</b>: ${escapeTelegram(lead.background)}\n` +
      `üìû <b>–ö–æ–Ω—Ç–∞–∫—Ç</b>: ${escapeTelegram(lead.contact)}\n` +
      `üìù <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</b>: ${escapeTelegram(lead.message || "‚Äî")}\n` +
      `üîó <b>–ò—Å—Ç–æ—á–Ω–∏–∫</b>: ${escapeTelegram(lead.source || "‚Äî")}`;

    const emailSubject = `–ó–∞—è–≤–∫–∞ –í–µ–ª–Ω–µ–π—Ä–æ ‚Äî ${lead.city} ‚Äî ${lead.name}`;
    const emailHtml = `
      <div style="font-family:Arial,sans-serif;line-height:1.5">
        <h2 style="margin:0 0 12px">–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ ‚Äî –í–µ–ª–Ω–µ–π—Ä–æ</h2>
        <p style="margin:0 0 12px;color:#555">–í—Ä–µ–º—è: ${ts}</p>
        <table cellpadding="6" cellspacing="0" style="border-collapse:collapse">
          <tr><td><b>–ò–º—è</b></td><td>${lead.name}</td></tr>
          <tr><td><b>–ö–æ–Ω—Ç–∞–∫—Ç</b></td><td>${lead.contact}</td></tr>
          <tr><td><b>–ì–æ—Ä–æ–¥</b></td><td>${lead.city}</td></tr>
          <tr><td><b>–§–æ—Ä–º–∞—Ç</b></td><td>${lead.format}</td></tr>
          <tr><td><b>–ö—Ç–æ</b></td><td>${lead.background}</td></tr>
          <tr><td><b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</b></td><td>${lead.message || "‚Äî"}</td></tr>
          <tr><td><b>–ò—Å—Ç–æ—á–Ω–∏–∫</b></td><td>${lead.source || "‚Äî"}</td></tr>
        </table>
      </div>
    `;
    const emailText =
      `–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ ‚Äî –í–µ–ª–Ω–µ–π—Ä–æ\n` +
      `–í—Ä–µ–º—è: ${ts}\n` +
      `–ò–º—è: ${lead.name}\n` +
      `–ö–æ–Ω—Ç–∞–∫—Ç: ${lead.contact}\n` +
      `–ì–æ—Ä–æ–¥: ${lead.city}\n` +
      `–§–æ—Ä–º–∞—Ç: ${lead.format}\n` +
      `–ö—Ç–æ: ${lead.background}\n` +
      `–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${lead.message || "‚Äî"}\n` +
      `–ò—Å—Ç–æ—á–Ω–∏–∫: ${lead.source || "‚Äî"}\n`;

    const [tg, em] = await Promise.all([
      sendToTelegram(telegramText),
      sendToEmail(emailSubject, emailHtml, emailText),
    ]);

    // –°—á–∏—Ç–∞–µ–º —É—Å–ø–µ—Ö–æ–º, –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–∞–Ω–∞–ª –ø—Ä–æ—à—ë–ª
    const ok = (tg as any).ok || (em as any).ok;

    return NextResponse.json({
      ok,
      telegram: tg,
      email: em,
    });
  } catch (e: any) {
    return NextResponse.json({ ok: false, error: e?.message || "Server error" }, { status: 500 });
  }
}
